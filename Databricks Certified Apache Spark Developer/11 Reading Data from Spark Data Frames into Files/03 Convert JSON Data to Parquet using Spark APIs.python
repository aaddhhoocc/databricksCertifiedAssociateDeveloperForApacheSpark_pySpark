{"version":"NotebookV1","origId":1575837098435103,"name":"03 Convert JSON Data to Parquet using Spark APIs","language":"python","commands":[{"version":"CommandV1","origId":1575837098435104,"guid":"bc6c5076-5c3f-4f4e-8be7-9ef745376e73","subtype":"command","commandType":"auto","position":9.0,"command":"import getpass\nusername = getpass.getuser()","commandVersion":0,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1641494854205,"submitTime":1641494854190,"finishTime":1641494854228,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"a226e85d-4847-4394-b68b-4e1fb0ee1c3d"},{"version":"CommandV1","origId":1575837098435105,"guid":"7dacb588-6e85-4291-b4b1-290352ff1a09","subtype":"command","commandType":"auto","position":10.0,"command":"input_dir = '/public/retail_db_json'\noutput_dir = f'/user/{username}/retail_db_parquet'","commandVersion":19,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1641494854499,"submitTime":1641494854518,"finishTime":1641494854513,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"0ffdd223-6c3c-4c45-b672-fb8e28325e20"},{"version":"CommandV1","origId":1575837098435106,"guid":"da3ee8e0-0a4b-49b8-bab9-bbbfa1002c88","subtype":"command","commandType":"auto","position":11.0,"command":"for file_details in dbutils.fs.ls(input_dir):\n    if not ('.git' in file_details.path or file_details.path.endswith('sql')):\n        print(f'Converting data in {file_details.path} folder from json to parquet')\n        data_set_dir = file_details.path.split('/')[-2]\n        df = spark.read.json(file_details.path)\n        df.coalesce(1).write.parquet(f'{output_dir}/{data_set_dir}', mode='overwrite')","commandVersion":121,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\">Converting data in dbfs:/public/retail_db_json/categories/ folder from json to parquet\nConverting data in dbfs:/public/retail_db_json/customers/ folder from json to parquet\nConverting data in dbfs:/public/retail_db_json/departments/ folder from json to parquet\nConverting data in dbfs:/public/retail_db_json/order_items/ folder from json to parquet\nConverting data in dbfs:/public/retail_db_json/orders/ folder from json to parquet\nConverting data in dbfs:/public/retail_db_json/products/ folder from json to parquet\n</div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[{"name":"df","typeStr":"pyspark.sql.dataframe.DataFrame","schema":{"fields":[{"metadata":{},"name":"product_category_id","nullable":true,"type":"long"},{"metadata":{},"name":"product_description","nullable":true,"type":"string"},{"metadata":{},"name":"product_id","nullable":true,"type":"long"},{"metadata":{},"name":"product_image","nullable":true,"type":"string"},{"metadata":{},"name":"product_name","nullable":true,"type":"string"},{"metadata":{},"name":"product_price","nullable":true,"type":"double"}],"type":"struct"},"tableIdentifier":null}],"metadata":{}},"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1641494854950,"submitTime":1641494854965,"finishTime":1641494865128,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"b0f2dda7-8535-479d-a84b-aa7e7e9f6096"},{"version":"CommandV1","origId":1575837098435107,"guid":"3fc3f350-7294-4c79-ab98-e264770dc577","subtype":"command","commandType":"auto","position":12.0,"command":"dbutils.fs.ls(f'/user/{username}/retail_db_parquet/orders')","commandVersion":6,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\">Out[4]: [FileInfo(path=&#39;dbfs:/user/root/retail_db_parquet/orders/_committed_2813264261469267571&#39;, name=&#39;_committed_2813264261469267571&#39;, size=223),\n FileInfo(path=&#39;dbfs:/user/root/retail_db_parquet/orders/_committed_3739854076266658903&#39;, name=&#39;_committed_3739854076266658903&#39;, size=123),\n FileInfo(path=&#39;dbfs:/user/root/retail_db_parquet/orders/_committed_7198418882314090348&#39;, name=&#39;_committed_7198418882314090348&#39;, size=232),\n FileInfo(path=&#39;dbfs:/user/root/retail_db_parquet/orders/_committed_7958689718562853532&#39;, name=&#39;_committed_7958689718562853532&#39;, size=222),\n FileInfo(path=&#39;dbfs:/user/root/retail_db_parquet/orders/_committed_vacuum4032435399200819253&#39;, name=&#39;_committed_vacuum4032435399200819253&#39;, size=96),\n FileInfo(path=&#39;dbfs:/user/root/retail_db_parquet/orders/_started_2813264261469267571&#39;, name=&#39;_started_2813264261469267571&#39;, size=0),\n FileInfo(path=&#39;dbfs:/user/root/retail_db_parquet/orders/_started_7958689718562853532&#39;, name=&#39;_started_7958689718562853532&#39;, size=0),\n FileInfo(path=&#39;dbfs:/user/root/retail_db_parquet/orders/part-00000-tid-2813264261469267571-eecb8f31-4c90-4763-89c5-6e2d7f0fafb1-168-1-c000.snappy.parquet&#39;, name=&#39;part-00000-tid-2813264261469267571-eecb8f31-4c90-4763-89c5-6e2d7f0fafb1-168-1-c000.snappy.parquet&#39;, size=489203)]</div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1641494865135,"submitTime":1641494856548,"finishTime":1641494865173,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"8b0d1aab-403d-4219-b00b-d30208a76c3b"},{"version":"CommandV1","origId":1575837098435108,"guid":"e9d2ed71-6412-4114-975c-f7e04dc982cd","subtype":"command","commandType":"auto","position":13.0,"command":"orders = spark.read.parquet(f'/user/{username}/retail_db_parquet/orders')","commandVersion":8,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[{"name":"orders","typeStr":"pyspark.sql.dataframe.DataFrame","schema":{"fields":[{"metadata":{},"name":"order_customer_id","nullable":true,"type":"long"},{"metadata":{},"name":"order_date","nullable":true,"type":"string"},{"metadata":{},"name":"order_id","nullable":true,"type":"long"},{"metadata":{},"name":"order_status","nullable":true,"type":"string"}],"type":"struct"},"tableIdentifier":null}],"metadata":{}},"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1641494865178,"submitTime":1641494857698,"finishTime":1641494865635,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"1193b56d-862f-4c80-b23f-e71faa389aa3"},{"version":"CommandV1","origId":1575837098435109,"guid":"369b7544-43e1-4411-9dd2-68dc9c96d127","subtype":"command","commandType":"auto","position":14.0,"command":"orders.dtypes","commandVersion":3,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\">Out[24]: [(&#39;order_customer_id&#39;, &#39;bigint&#39;),\n (&#39;order_date&#39;, &#39;string&#39;),\n (&#39;order_id&#39;, &#39;bigint&#39;),\n (&#39;order_status&#39;, &#39;string&#39;)]</div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1641494296368,"submitTime":1641494296382,"finishTime":1641494296383,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"501e8a2a-89ee-4461-b9ab-3e75c49739b6"},{"version":"CommandV1","origId":1575837098435110,"guid":"96bf6d2d-112b-4a59-9377-d54fc22998ce","subtype":"command","commandType":"auto","position":15.0,"command":"orders.show()","commandVersion":2,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\">+-----------------+--------------------+--------+---------------+\n|order_customer_id|          order_date|order_id|   order_status|\n+-----------------+--------------------+--------+---------------+\n|            11599|2013-07-25 00:00:...|       1|         CLOSED|\n|              256|2013-07-25 00:00:...|       2|PENDING_PAYMENT|\n|            12111|2013-07-25 00:00:...|       3|       COMPLETE|\n|             8827|2013-07-25 00:00:...|       4|         CLOSED|\n|            11318|2013-07-25 00:00:...|       5|       COMPLETE|\n|             7130|2013-07-25 00:00:...|       6|       COMPLETE|\n|             4530|2013-07-25 00:00:...|       7|       COMPLETE|\n|             2911|2013-07-25 00:00:...|       8|     PROCESSING|\n|             5657|2013-07-25 00:00:...|       9|PENDING_PAYMENT|\n|             5648|2013-07-25 00:00:...|      10|PENDING_PAYMENT|\n|              918|2013-07-25 00:00:...|      11| PAYMENT_REVIEW|\n|             1837|2013-07-25 00:00:...|      12|         CLOSED|\n|             9149|2013-07-25 00:00:...|      13|PENDING_PAYMENT|\n|             9842|2013-07-25 00:00:...|      14|     PROCESSING|\n|             2568|2013-07-25 00:00:...|      15|       COMPLETE|\n|             7276|2013-07-25 00:00:...|      16|PENDING_PAYMENT|\n|             2667|2013-07-25 00:00:...|      17|       COMPLETE|\n|             1205|2013-07-25 00:00:...|      18|         CLOSED|\n|             9488|2013-07-25 00:00:...|      19|PENDING_PAYMENT|\n|             9198|2013-07-25 00:00:...|      20|     PROCESSING|\n+-----------------+--------------------+--------+---------------+\nonly showing top 20 rows\n\n</div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1641494302346,"submitTime":1641494302356,"finishTime":1641494307387,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"72803e3d-51c0-4b9c-bdcd-f84e7fad8fae"},{"version":"CommandV1","origId":1575837098435111,"guid":"c4e42dd1-e380-4a2a-8360-bba6f390d387","subtype":"command","commandType":"auto","position":16.0,"command":"# Copy all the data with comma separator to pipe separator\n\nimport getpass\nusername = getpass.getuser()\n\ninput_dir = '/public/retail_db'\noutput_dir = f'/user/{username}/retail_db_pipe'","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"21b6b8be-cdfc-4193-92e8-cc6e7f6500b6"},{"version":"CommandV1","origId":1575837098435112,"guid":"104e235d-964b-4c1c-9580-4392f91c3158","subtype":"command","commandType":"auto","position":17.0,"command":"# Generate CSV files with pipe delimiter\nfor file_details in dbutils.fs.ls(input_dir):\n    if 'git' not in file_details.path and 'sql' not in file_details.path:\n        print(f'Converting data in {file_details.path} folder from comma separated to pipe separated')\n        df = spark.read.csv(file_details.path)\n        folder_name = file_details.path.split('/')[-2]\n        df.coalesce(1).write.mode('overwrite').csv(f'{output_dir}/{folder_name}', sep='|')","commandVersion":13,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"4fdf6e41-a2f2-4904-95fb-f32fb295ed18"}],"dashboards":[],"guid":"73195fb1-94a4-4a3c-bb73-f6b8b884eb97","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{"pythonIndentUnit":4}}