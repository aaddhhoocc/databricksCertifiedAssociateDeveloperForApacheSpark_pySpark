{"version":"NotebookV1","origId":1575837098435917,"name":"10 Overview of Broadcast Join in Spark","language":"python","commands":[{"version":"CommandV1","origId":1575837098435918,"guid":"7c681bf6-293b-4db3-b2a7-d2b4a062b5e5","subtype":"command","commandType":"auto","position":0.25,"command":"%md\n\n* It is also known as map side as well as replicated join.\n* The smaller data set will be broadcasted to all the executors in the cluster.\n* The size of the smaller data set is driven by `spark.sql.autoBroadcastJoinThreshold`.\n* We can even perform broadcast join when the smaller data set size is greater than `spark.sql.autoBroadcastJoinThreshold` by using `broadcast` function from `pyspark.sql.functions`.\n* We can disable broadcast join by setting `spark.sql.autoBroadcastJoinThreshold` value to 0.\n* If broadcast join is disabled then it will result in reduce side join.\n* Make sure to setup multinode cluster using 28 GB Memory, 4 Cores each. Configure scaling between 2 and 4 nodes. Driver can be of minimum configuration.","commandVersion":149,"state":"finished","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"f5a7bb06-44e6-46b8-a8a5-f1ab8fc7404c"},{"version":"CommandV1","origId":1575837098435919,"guid":"bd17f793-1a7c-46d7-a963-0171ba87e963","subtype":"command","commandType":"auto","position":0.375,"command":"# Default size is 10 MB.\nspark.conf.get('spark.sql.autoBroadcastJoinThreshold')","commandVersion":15,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\">Out[1]: &#39;10485760b&#39;</div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1641683446678,"submitTime":1641683446694,"finishTime":1641683446705,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"1f5d8013-b2c0-4729-9e29-f8dcfb63e49c"},{"version":"CommandV1","origId":1575837098435920,"guid":"369cb857-4953-4417-9f81-7377822ec5d5","subtype":"command","commandType":"auto","position":0.4375,"command":"# We can disable broadcast join using this approach\nspark.conf.set('spark.sql.autoBroadcastJoinThreshold', '0')","commandVersion":13,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1641683451713,"submitTime":1641683451730,"finishTime":1641683451737,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"b5091a97-1a78-47c9-9afc-2698d5774e2e"},{"version":"CommandV1","origId":1575837098435921,"guid":"544e2b80-8cb1-4a1a-9882-9a5a216b6cba","subtype":"command","commandType":"auto","position":3.1875,"command":"# Resetting to original value\nspark.conf.set('spark.sql.autoBroadcastJoinThreshold', '10485760b')","commandVersion":14,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1641683462552,"submitTime":1641683462563,"finishTime":1641683462567,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"e8a6e7b2-f1f8-4274-b031-58b9ed953352"},{"version":"CommandV1","origId":1575837098435922,"guid":"54de698c-323a-4c86-97da-123c9de8ab7f","subtype":"command","commandType":"auto","position":11.4375,"command":"# 1+ GB Data Set\nclickstream = spark.read.csv('dbfs:/databricks-datasets/wikipedia-datasets/data-001/clickstream/raw-uncompressed/', sep='\\t', header=True)","commandVersion":8,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[{"name":"clickstream","typeStr":"pyspark.sql.dataframe.DataFrame","schema":{"fields":[{"metadata":{},"name":"prev_id","nullable":true,"type":"string"},{"metadata":{},"name":"curr_id","nullable":true,"type":"string"},{"metadata":{},"name":"n","nullable":true,"type":"string"},{"metadata":{},"name":"prev_title","nullable":true,"type":"string"},{"metadata":{},"name":"curr_title","nullable":true,"type":"string"},{"metadata":{},"name":"type","nullable":true,"type":"string"}],"type":"struct"},"tableIdentifier":null}],"metadata":{}},"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1641683467236,"submitTime":1641683467253,"finishTime":1641683470671,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"b543e9c6-1d8a-4210-8b24-537a63c2a636"},{"version":"CommandV1","origId":1575837098435923,"guid":"18b1f032-1e74-4c38-ba89-ef5d48ef2a17","subtype":"command","commandType":"auto","position":12.4375,"command":"# 10+ GB Data Set\narticles = spark.read.parquet('dbfs:/databricks-datasets/wikipedia-datasets/data-001/en_wikipedia/articles-only-parquet/')","commandVersion":12,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[{"name":"articles","typeStr":"pyspark.sql.dataframe.DataFrame","schema":{"fields":[{"metadata":{},"name":"title","nullable":true,"type":"string"},{"metadata":{},"name":"id","nullable":true,"type":"integer"},{"metadata":{},"name":"revisionId","nullable":true,"type":"integer"},{"metadata":{},"name":"revisionTimestamp","nullable":true,"type":"timestamp"},{"metadata":{},"name":"revisionUsername","nullable":true,"type":"string"},{"metadata":{},"name":"revisionUsernameId","nullable":true,"type":"integer"},{"metadata":{},"name":"text","nullable":true,"type":"string"}],"type":"struct"},"tableIdentifier":null}],"metadata":{}},"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1641683470895,"submitTime":1641683470910,"finishTime":1641683474136,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"20d75a71-c4aa-4c0c-ba35-6e2520a2ead0"},{"version":"CommandV1","origId":1575837098435924,"guid":"5ae7e505-b3f5-4061-8bf2-7b31a2645f72","subtype":"command","commandType":"auto","position":12.6875,"command":"%%time\n\n# Default will be reduce side join as the size of smaller data set is more than 10 MB (default broadcast size)\nclickstream.join(articles, articles.id == clickstream.curr_id).count()","commandVersion":30,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\">CPU times: user 720 ms, sys: 294 ms, total: 1.01 s\nWall time: 4min\nOut[6]: 19959125</div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1641683533790,"submitTime":1641683533809,"finishTime":1641683774134,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"2474c53c-e1d9-4563-b56f-8557f378744c"},{"version":"CommandV1","origId":1575837098435925,"guid":"62a12eae-1bf0-410d-bd16-4d158f3a435e","subtype":"command","commandType":"auto","position":12.8125,"command":"%md\n\n* Review SQL Plan visualization to confirm the previous query have used sort merge join.","commandVersion":28,"state":"finished","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"bd99db94-4268-4924-8a10-19569cf95c67"},{"version":"CommandV1","origId":1575837098435926,"guid":"eb2e2578-cb98-4971-bb2a-daf989f077e1","subtype":"command","commandType":"auto","position":12.9375,"command":"from pyspark.sql.functions import broadcast","commandVersion":7,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\"></div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1641683786443,"submitTime":1641683786473,"finishTime":1641683786459,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"c15dd304-cd5f-410c-afa9-cb48abe46b8e"},{"version":"CommandV1","origId":1575837098435927,"guid":"9d2bdbef-5f9f-4b2b-aedd-35b7c06d22e4","subtype":"command","commandType":"auto","position":13.4375,"command":"%%time\n# We can use broadcast function to override existing broadcast join threshold\n# We can also override by using this code spark.conf.set('spark.sql.autoBroadcastJoinThreshold', '1500m')\nbroadcast(clickstream).join(articles, articles.id == clickstream.curr_id).count()","commandVersion":54,"state":"finished","results":{"type":"listResults","data":[{"type":"html","data":"<div class=\"ansiout\">CPU times: user 691 ms, sys: 342 ms, total: 1.03 s\nWall time: 4min\nOut[8]: 19959125</div>","arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}}],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":1641683787700,"submitTime":1641683787727,"finishTime":1641684027951,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"6588821e-e3e3-43d1-bd56-bf72449094fc"},{"version":"CommandV1","origId":1575837098435928,"guid":"5847377e-02f0-4b03-8ae1-9fa17252df92","subtype":"command","commandType":"auto","position":14.6875,"command":"%md\n\n* Review SQL Plan visualization to confirm the previous query have used broadcast based join.","commandVersion":1,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"603457e3-f90c-48f7-964f-88ef195783aa"},{"version":"CommandV1","origId":1575837098435929,"guid":"ae7e099a-ab56-4a16-848f-a1cfd5fb9093","subtype":"command","commandType":"auto","position":15.6875,"command":"","commandVersion":0,"state":"error","results":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultSubCmdIds":[],"tableResultIndex":null,"nuid":"de85d4dc-78b0-4293-93e5-bcc0221ca1c9"}],"dashboards":[],"guid":"2399675c-b85e-43c8-981e-b02697b3af65","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{"pythonIndentUnit":4}}